# CI / Publish workflow for ConnectWiseAutomateAgent
#
# Philosophy:
#   Full testing (Pester, PSScriptAnalyzer) is done locally before pushing.
#   This workflow is intentionally lightweight — it smoke-tests the module,
#   builds the single-file artifact, publishes to PSGallery, and creates
#   a GitHub Release with the single-file asset attached.
#
# Branch strategy:
#   develop push  → smoke test → build → publish prerelease → GitHub Release (prerelease)
#   main push     → smoke test → build → publish stable → GitHub Release (stable)
#   pull requests → smoke test → build (no publish, no release)
#
# Publish gating:
#   - Prerelease publish requires a Prerelease tag in the manifest (e.g., 'alpha001')
#   - Stable publish requires the Prerelease tag to be removed from the manifest
#   - Both publish jobs use the PSGallery environment for optional protection rules
#   - GitHub Releases are created only after successful PSGallery publish
#
# Required secrets:
#   PSGALLERY_API_KEY — NuGet API key for the PowerShell Gallery
#
# Required permissions:
#   contents: write — for creating git tags and GitHub Releases (set per-job)

name: CI / Publish

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  smoke-test:
    name: Smoke Test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Validate module manifest
        shell: pwsh
        run: |
          $manifest = Test-ModuleManifest -Path ConnectWiseAutomateAgent\ConnectWiseAutomateAgent.psd1 -ErrorAction Stop
          Write-Host "Module: $($manifest.Name) v$($manifest.Version)"
          $prerelease = $manifest.PrivateData.PSData.Prerelease
          if ($prerelease) { Write-Host "Prerelease: $prerelease" }

      - name: Verify module imports and exports
        shell: pwsh
        run: |
          Import-Module .\ConnectWiseAutomateAgent\ConnectWiseAutomateAgent.psd1 -Force -ErrorAction Stop
          $functions = (Get-Module ConnectWiseAutomateAgent).ExportedFunctions.Keys
          $aliases   = (Get-Module ConnectWiseAutomateAgent).ExportedAliases.Keys
          Write-Host "Exported $($functions.Count) functions, $($aliases.Count) aliases"
          if ($functions.Count -lt 25) { throw "Expected at least 25 exported functions, got $($functions.Count)" }
          if ($aliases.Count -lt 27)   { throw "Expected at least 27 exported aliases, got $($aliases.Count)" }

  build:
    name: Build
    needs: smoke-test
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Build single-file distribution
        shell: pwsh
        run: .\Build\SingleFileBuild.ps1

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: ConnectWiseAutomateAgent-SingleFile
          path: ConnectWiseAutomateAgent.ps1

  publish-prerelease:
    name: Publish Prerelease
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    needs: build
    runs-on: windows-latest
    environment: PSGallery
    steps:
      - uses: actions/checkout@v4

      - name: Verify prerelease tag is set
        shell: pwsh
        run: |
          $manifest = Import-PowerShellDataFile ConnectWiseAutomateAgent\ConnectWiseAutomateAgent.psd1
          $prerelease = $manifest.PrivateData.PSData.Prerelease
          if (-not $prerelease) {
            Write-Error "Prerelease tag is not set in the manifest. Skipping prerelease publish."
            exit 1
          }
          Write-Host "Prerelease tag: $prerelease"
          Write-Host "Full version: $($manifest.ModuleVersion)-$prerelease"

      - name: Publish to PSGallery (prerelease)
        shell: pwsh
        env:
          NUGET_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: .\Build\Publish-CWAAModule.ps1 -NuGetApiKey $env:NUGET_API_KEY

  publish-stable:
    name: Publish Stable
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: build
    runs-on: windows-latest
    environment: PSGallery
    steps:
      - uses: actions/checkout@v4

      - name: Verify no prerelease tag
        shell: pwsh
        run: |
          $manifest = Import-PowerShellDataFile ConnectWiseAutomateAgent\ConnectWiseAutomateAgent.psd1
          $prerelease = $manifest.PrivateData.PSData.Prerelease
          if ($prerelease) {
            Write-Error "Prerelease tag '$prerelease' is still set in the manifest. Remove it before publishing a stable release."
            exit 1
          }
          Write-Host "Version: $($manifest.ModuleVersion) (stable)"

      - name: Publish to PSGallery (stable)
        shell: pwsh
        env:
          NUGET_API_KEY: ${{ secrets.PSGALLERY_API_KEY }}
        run: .\Build\Publish-CWAAModule.ps1 -NuGetApiKey $env:NUGET_API_KEY

  # ─── GitHub Release jobs ──────────────────────────────────────────────────
  # These mirror the publish jobs above: release-prerelease creates a
  # prerelease GitHub Release on develop, release-stable creates a stable
  # GitHub Release on main. Tags are created explicitly to avoid gh CLI
  # --target bugs. Each job has an explicit if condition for clarity.

  release-prerelease:
    name: GitHub Release (Prerelease)
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push' && !failure() && !cancelled()
    needs: publish-prerelease
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Read version from manifest
        id: version
        shell: pwsh
        run: |
          $manifest = Import-PowerShellDataFile ConnectWiseAutomateAgent\ConnectWiseAutomateAgent.psd1
          $moduleVersion = $manifest.ModuleVersion
          $prerelease = $manifest.PrivateData.PSData.Prerelease
          $fullVersion = if ($prerelease) { "$moduleVersion-$prerelease" } else { $moduleVersion }
          $tag = "v$fullVersion"
          Write-Host "Version: $fullVersion"
          Write-Host "Tag: $tag"
          "full_version=$fullVersion" >> $env:GITHUB_OUTPUT
          "tag=$tag" >> $env:GITHUB_OUTPUT

      - name: Check if release already exists
        id: check
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $tag = '${{ steps.version.outputs.tag }}'
          $existing = gh release view $tag 2>&1
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Release $tag already exists. Skipping."
            "skip=true" >> $env:GITHUB_OUTPUT
          }
          else {
            Write-Host "Release $tag does not exist. Proceeding."
            "skip=false" >> $env:GITHUB_OUTPUT
          }

      - name: Extract release notes from CHANGELOG
        if: steps.check.outputs.skip != 'true'
        shell: pwsh
        run: .\Build\Extract-ChangelogEntry.ps1 -Version '${{ steps.version.outputs.full_version }}' -OutputPath release-notes.md

      - name: Download build artifact
        if: steps.check.outputs.skip != 'true'
        uses: actions/download-artifact@v4
        with:
          name: ConnectWiseAutomateAgent-SingleFile
          path: artifact

      - name: Create git tag
        if: steps.check.outputs.skip != 'true'
        shell: pwsh
        run: |
          git tag ${{ steps.version.outputs.tag }} ${{ github.sha }}
          git push origin ${{ steps.version.outputs.tag }}

      - name: Create GitHub Release
        if: steps.check.outputs.skip != 'true'
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create '${{ steps.version.outputs.tag }}' `
            artifact/ConnectWiseAutomateAgent.ps1 `
            --title 'ConnectWiseAutomateAgent ${{ steps.version.outputs.full_version }}' `
            --notes-file release-notes.md `
            --prerelease `
            --verify-tag

  release-stable:
    name: GitHub Release (Stable)
    if: github.ref == 'refs/heads/main' && github.event_name == 'push' && !failure() && !cancelled()
    needs: publish-stable
    runs-on: windows-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ github.sha }}

      - name: Read version from manifest
        id: version
        shell: pwsh
        run: |
          $manifest = Import-PowerShellDataFile ConnectWiseAutomateAgent\ConnectWiseAutomateAgent.psd1
          $moduleVersion = $manifest.ModuleVersion
          $fullVersion = $moduleVersion
          $tag = "v$fullVersion"
          Write-Host "Version: $fullVersion"
          Write-Host "Tag: $tag"
          "full_version=$fullVersion" >> $env:GITHUB_OUTPUT
          "tag=$tag" >> $env:GITHUB_OUTPUT

      - name: Check if release already exists
        id: check
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          $tag = '${{ steps.version.outputs.tag }}'
          $existing = gh release view $tag 2>&1
          if ($LASTEXITCODE -eq 0) {
            Write-Host "Release $tag already exists. Skipping."
            "skip=true" >> $env:GITHUB_OUTPUT
          }
          else {
            Write-Host "Release $tag does not exist. Proceeding."
            "skip=false" >> $env:GITHUB_OUTPUT
          }

      - name: Extract release notes from CHANGELOG
        if: steps.check.outputs.skip != 'true'
        shell: pwsh
        run: .\Build\Extract-ChangelogEntry.ps1 -Version '${{ steps.version.outputs.full_version }}' -OutputPath release-notes.md

      - name: Download build artifact
        if: steps.check.outputs.skip != 'true'
        uses: actions/download-artifact@v4
        with:
          name: ConnectWiseAutomateAgent-SingleFile
          path: artifact

      - name: Create git tag
        if: steps.check.outputs.skip != 'true'
        shell: pwsh
        run: |
          git tag ${{ steps.version.outputs.tag }} ${{ github.sha }}
          git push origin ${{ steps.version.outputs.tag }}

      - name: Create GitHub Release
        if: steps.check.outputs.skip != 'true'
        shell: pwsh
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh release create '${{ steps.version.outputs.tag }}' `
            artifact/ConnectWiseAutomateAgent.ps1 `
            --title 'ConnectWiseAutomateAgent ${{ steps.version.outputs.full_version }}' `
            --notes-file release-notes.md `
            --verify-tag
